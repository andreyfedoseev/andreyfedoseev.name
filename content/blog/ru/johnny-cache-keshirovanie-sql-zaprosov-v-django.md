Title: johnny-cache - кэширование SQL-запросов в Django
Date: 2010-03-01T15:04:00
Tags: django, sql, кэширование
Slug: 22
Feed: false

<p>Оказывается, Джонни Кэш — это не только имя <a href="http://andreyfedoseev.name/blog/post/2/johnny-cash-gods-gonna-cut-you-down/">легендарного кантри-певца</a>. Такое же название носит модуль для кэширования SQL-запросов в Django.</p>
<p>Суть его действия заключается в том, что он кэширует результат выполнения <em>всех</em> <code>SELECT</code>'ов в memcached. Кэш сбрасывается при выполнении <code>INSERT</code>, <code>UPDATE</code> или <code>DELETE</code> для соответствующей таблицы. Если <code>SELECT</code> выбирает данные из нескольких таблиц, то кэш для этого запроса сбросится, если будет выполнена запись в любую из них.</p>
<!-- more -->
<p>Подключить такое кэширование предельно просто. КО рекомендует начать с установки пакета <code>johnny—cache</code>, который можно <a href="http://pypi.python.org/pypi/johnny-cache/">скачать с PyPI</a> или вытянуть из <a href="http://dev.jmoiron.net/hg/johnny-cache">mercurial-репозитория</a>. Затем нужно внести следующие изменения в <code>settings.py</code>:</p>
<p>1. Добавить <code>jhonny</code> в список установленных приложений</p>
<pre>{% highlight py %}INSTALLED_APPS = (
    # ...
    'johnny',
){% endhighlight %}</pre>
<p><small>Это делать не обязательно, будет работать и так. Чисто декоративный момент.</small></p>
<p>2. Подключить middleware</p>
<pre>{% highlight py %}MIDDLEWARE_CLASSES = (
    'johnny.middleware.LocalStoreClearMiddleware',
    'johnny.middleware.QueryCacheMiddleware',
    # ...
){% endhighlight %}</pre>
<p><small>А вот это нужно сделать обязательно, иначе ничего не получится.</small></p>
<p>3. И, наконец, настроить кэширующий бэкенд</p>
<pre>{% highlight py %}CACHE_BACKEND = 'johnny.backends.memcached://localhost:11211'
JOHNNY_MIDDLEWARE_KEY_PREFIX='jc_myproj'
{% endhighlight %}</pre>
<p>В <code>CACHE_BACKEND</code> указывается хост/порт memcached. В данном случае это <code>localhost:11211</code>.</p>
<p><code>JOHNNY_MIDDLEWARE_KEY_PREFIX</code> — это префикс для ключей memcached. Он нужен, чтобы избежать конфликтов с другими проектами, которые используют тот же кэш. Соответственно, он должен быть уникальным для каждого проекта.</p>
<p>После этих нехитрых манипуляций перезагрузите люблю страницу вашего сайта и наслаждайтесь заветным нулём во вкладке "SQL" в <code>debug-toolbar</code>.</p>
<p>Однако, я советую хорошенько подумать над тем, насколько это подойдёт для вашего конкретного приложения. Дело в том, что при таком подходе кэшироваться будут только SQL-запросы. Если приложение пишет в базу достаточно часто, то эффективность такого кэширования ощутимо понизится. К тому же, узким местом являются не только запросы к базе. Кэшировать нужно и другие "дорогие" операции. А ведь память не резиновая, на всех может и не хватить.</p>
<p>С другой стороны, <em>johnny-cache</em> позволяет повысить производительность с минимальным количеством телодвижений. В частности, скорость генерации главной страницы моего бложика повысилась на 30% (при испытании в тепличных условиях). При этом, использовать дополнительное кэширование помимо <em>johnny-cache</em> мне лениво, да и нет необходимости. Так что для меня этот вариант вполне подходит.</p>
<p><a href="http://packages.python.org/johnny-cache/">Сайт проекта johnny-cache</a> с более-менее подробной документацией.</p>
